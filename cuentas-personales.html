<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Finanzas - Historial Intacto</title>
  <style>
    :root {
      --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc;
      --text-dim: #94a3b8; --accent: #38bdf8; --success: #4ade80;
      --danger: #f87171; --warning: #fb923c; --border: #334155;
      --neon-purple: #a855f7; --neon-lime: #84cc16;
    }
    /* Forzar icono claro en date input */
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px; }
    .contenedor { max-width: 1150px; margin: auto; background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .titulo-principal { text-align: center; color: var(--accent); margin-bottom: 10px; font-weight: bold; }
    /* Barra de a√±o */
    .anio-toolbar{
      display:flex; align-items:center; justify-content:center; gap:10px;
      margin: 8px 0 12px; position: relative;
    }
    .anio-toolbar .anio-chip{
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(56,189,248,.15), rgba(56,189,248,.08));
      border: 1px solid rgba(56,189,248,.35);
      color: #e2f3ff; padding: 10px 14px; border-radius: 999px;
      box-shadow: 0 4px 14px rgba(56,189,248,.18);
    }
    .anio-toolbar label{
      font-size: .8rem; color: #cbe7ff;
      text-transform: uppercase; letter-spacing: .6px;
    }


.mes-btn.active {
  background: var(--accent) !important;
  color: var(--bg-body) !important;
  border-color: var(--accent) !important;
}

    .anio-toolbar select{
      background: #0b1220; color: #e5f2ff;
      border: 1px solid rgba(56,189,248,.45);
      padding: 8px 12px; border-radius: 10px;
      font-weight: 700; min-width: 130px; font-size: .92rem;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, transform .1s ease;
    }
    .anio-toolbar select:hover{
      border-color: rgba(56,189,248,.7);
      box-shadow: 0 0 0 3px rgba(56,189,248,.15);
    }
    .anio-toolbar select:focus{
      border-color: rgba(168,85,247,.85);
      box-shadow: 0 0 0 3px rgba(168,85,247,.22);
      transform: translateY(-1px);
    }
    @media (min-width: 680px){
      .anio-toolbar.sticky { position: sticky; top: 6px; z-index: 5; }
    }
    /* ALERTAS */
    .panel-alertas { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 12px; }
    .alerta-card { padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(15, 23, 42, 0.4); }
    .monitor-negativo { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
    .punto-info { background: rgba(0,0,0,0.2); padding: 6px; border-radius: 6px; }
    .punto-info label { display: block; font-size: 0.6rem; color: var(--text-dim); margin-bottom: 3px; text-transform: uppercase; }
    .punto-info span { font-family: 'JetBrains Mono', monospace; font-weight: bold; font-size: 0.85rem; }
    /* TABLA */
    .tabla-scroll { height: 380px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin: 12px 0 16px; background: #0f172a; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { background: #1e293b; color: var(--text-dim); padding: 10px; position: sticky; top: 0; text-transform: uppercase; font-size: 0.7rem; }
    td { padding: 6px; border-bottom: 1px solid var(--border); text-align: center; }
    .fila-hito { background: rgba(56, 189, 248, 0.08); border-bottom: 2px solid var(--accent) !important; }
    /* FORMULARIOS */
    .panel-entrada {
      background: rgba(15, 23, 42, 0.5); padding: 12px; border-radius: 10px; margin-bottom: 12px;
      display: grid; grid-template-columns: 1.2fr 1.8fr 1fr 1fr auto; gap: 8px; align-items: end;
    }
    input, select { background: var(--bg-body); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; font-size: 0.85rem; width: 100%; }
    .fijos-container { display: flex; gap: 10px; margin-bottom: 14px; }
    .bloque-fijos { flex: 1; background: rgba(15, 23, 42, 0.3); padding: 12px; border-radius: 10px; border: 1px solid var(--border); }
    .meses-selector { display: flex; gap: 2px; margin: 6px 0; flex-wrap: wrap; }
    .mes-btn { font-size: 0.6rem; padding: 4px 6px; border: 1px solid var(--border); border-radius: 3px; cursor: pointer; background: transparent; color: var(--text-dim); }
    .mes-btn.active { background: var(--accent); color: var(--bg-body); border-color: var(--accent); }
    .btn-add-mini { background: var(--accent); color: var(--bg-body); font-weight: bold; border: none; border-radius: 4px; cursor: pointer; height: 30px; width: 100%; }
    .item-fijo { border-top: 1px solid var(--border); padding: 8px 0; }
    .moneda-font { font-family: 'JetBrains Mono', monospace; font-weight: bold; }
    .btn-edit { background: #22c55e; border: none; border-radius: 4px; padding: 3px 6px; cursor: pointer; font-size: 0.75rem; }
    .btn-del { background: transparent; color: var(--danger); border: none; cursor: pointer; font-size: 0.95rem; }
    /* ===== MODO COMPACTO ===== */
    .compacto .bloque-fijos { padding: 8px !important; border-radius: 8px !important; }
    .compacto .bloque-fijos h3 { font-size: 0.72rem !important; margin: 0 0 6px 0 !important; }
    .compacto .meses-selector { gap: 2px !important; margin: 4px 0 !important; }
    .compacto .mes-btn { padding: 2px 4px !important; font-size: 0.58rem !important; }
    .compacto .btn-add-mini, .compacto .btn-edit, .compacto .btn-del { height: 24px !important; padding: 2px 6px !important; font-size: 0.68rem !important; }
    .compacto .item-fijo { padding: 6px 0 !important; margin: 0 !important; }
    .compacto .item-fijo b { font-size: 0.78rem !important; }
    .compacto .item-fijo span { font-size: 0.58rem !important; }
    .compacto #lista-ingresos,
    .compacto #lista-gastos,
    .compacto #lista-ahorros-fijos,
    .compacto #lista-tarjeta-fijos {
      display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 6px !important;
    }
    .compacto .item-fijo {
      display: grid !important;
      grid-template-columns: 1.3fr 0.7fr 1.1fr auto !important; /* concepto | importe | meses/d√≠a | acciones */
      align-items: center !important; gap: 8px !important;
    }
    .compacto .item-fijo > div { display: contents !important; }
    .compacto .item-fijo > div:nth-child(1) > b { grid-column: 1 / 2 !important; align-self: center !important; }
    .compacto .item-fijo > div:nth-child(1) > b:last-child { grid-column: 2 / 3 !important; justify-self: end !important; }
    .compacto .item-fijo > div:nth-child(2) > span { grid-column: 3 / 4 !important; color: var(--text-dim) !important; }
    .compacto .item-fijo > div:nth-child(2) > div { grid-column: 4 / 5 !important; justify-self: end !important; }

    /* Cabecera de botones */
    .toolbar { display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom: 12px; }
    .toolbar button { border-radius:6px; cursor:pointer; padding: 8px 14px; font-weight:bold; font-size:0.9rem; border:1px solid transparent; }
    .toolbar .secondary { background: transparent; color: #a7f3d0; border: 1px solid rgba(167, 243, 208, 0.25); font-size: 0.8rem; }

    /* --- IPC mini --- */
    .ipc-row { display: flex; align-items: center; gap: 6px; margin-top: 6px; }
    .ipc-row label { font-size: 0.62rem; color: var(--text-dim); }
    .ipc-row input[type="number"] { width: 56px; padding: 2px 4px; font-size: 0.72rem; border-radius: 4px; }
    .ipc-row .btn-ipc-mini { padding: 1px 4px !important; font-size: 0.55rem !important; height: 18px !important; border-radius: 3px; border: none; cursor: pointer; font-weight: 700; line-height: 1; }
    .ipc-row button.btn-ipc-mini {
      display: inline-flex !important; align-items: center !important; justify-content: center !important;
      height: 18px !important; min-height: 0 !important; padding: 0 6px !important; line-height: 16px !important;
      font-size: 0.62rem !important; font-weight: 700 !important; border-radius: 4px !important; border: none !important;
      background: var(--success) !important; color: #fff !important; width: auto !important; flex: 0 0 auto !important;
    }
    .ipc-row input[type="number"] {
      height: 18px !important; min-height: 0 !important; padding: 0 4px !important; font-size: 0.7rem !important; line-height: 16px !important;
    }
  </style>
</head>
<body>
  <div class="contenedor compacto" id="root">
    <h1 class="titulo-principal">Finanzas Personales</h1>

    <!-- Barra de selecci√≥n de a√±o (visible arriba) -->
    <div class="anio-toolbar sticky">
      <div class="anio-chip">
        <label for="select-anio">A√±o</label>
        <select id="select-anio" onchange="render()"></select>
      </div>
    </div>

    <!-- Barra de acciones -->
    <div class="toolbar">
      <button onclick="abrirResumen()" style="background:#d8b4fe; color:#581c87; border:1px solid #c084fc;">üìä VER RESUMEN GENERAL (2026 - 2035)</button>
      <button onclick="abrirDesglose()" style="background:#bae6fd; color:#0c4a6e; border:1px solid #7dd3fc;">üßæ DESGLOSE DE GASTOS/INGRESOS</button>
      <button class="secondary" onclick="toggleCompacto()">‚Üî Compactar / Expandir</button>
    </div>

    <div id="panel-alertas" class="panel-alertas"></div>

    <!-- TABLA -->
    <div class="tabla-scroll">
      <table>
        <thead><tr><th>Fecha</th><th>Concepto</th><th>Importe</th><th>Saldo Acumulado</th></tr></thead>
        <tbody id="cuerpo"></tbody>
      </table>
    </div>

    <!-- ENTRADA MANUAL -->
    <div class="panel-entrada" style="background: rgba(167, 243, 208, 0.07); border: 1px solid rgba(167, 243, 208, 0.2);">
      <div><label style="font-size:0.7rem; color:#a7f3d0; opacity:0.8;">Fecha</label><input type="date" id="input-fecha" style="border-color:rgba(167,243,208,0.2); color:white;"></div>
      <div><label style="font-size:0.7rem; color:#a7f3d0; opacity:0.8;">Concepto</label><input type="text" id="input-concepto" style="border-color:rgba(167,243,208,0.2);"></div>
      <div><label style="font-size:0.7rem; color:#a7f3d0; opacity:0.8;">Tipo</label><select id="input-tipo" style="border-color:rgba(167,243,208,0.2);"><option value="ingreso">Ingreso (+)</option><option value="gasto" selected>Gasto (-)</option></select></div>
      <div><label style="font-size:0.7rem; color:#a7f3d0; opacity:0.8;">Importe</label><input type="number" id="input-monto" style="border-color:rgba(167,243,208,0.2);"></div>
      <button class="btn-add-mini" onclick="agregarManual()" style="background:#065f46; color:#a7f3d0; border:1px solid rgba(167,243,208,0.3); height:30px;">A√±adir</button>
    </div>

    <!-- TARJETA: puntuales + fijos fin de mes -->
    <div style="background: rgba(167, 243, 208, 0.07); padding: 10px; border-radius: 10px; border: 1px solid rgba(167, 243, 208, 0.2);">
      <h4 style="color:#a7f3d0; margin:0 0 6px 0; font-size:0.72rem; text-transform:uppercase; letter-spacing:0.5px; opacity:0.85;">üí≥ Gasto Tarjeta (Carga fin de mes)</h4>
      <!-- Puntuales -->
      <div style="display:grid; grid-template-columns: 2fr 1fr auto; gap:8px; margin-bottom:8px;">
        <input type="text" id="tarjeta-con" placeholder="Concepto compra puntual..." style="border-color:rgba(167,243,208,0.2); background:rgba(15,23,42,0.6);">
        <input type="number" id="tarjeta-mon" placeholder="Importe ‚Ç¨" style="border-color:rgba(167,243,208,0.2); background:rgba(15,23,42,0.6);">
        <button onclick="a√±adirGastoTarjeta()" style="background:#065f46; color:#a7f3d0; border:1px solid rgba(167,243,208,0.3); border-radius:6px; cursor:pointer; padding:0 16px; font-weight:bold; font-size:0.8rem; height:30px;">A√±adir</button>
      </div>
      <!-- Fijos de tarjeta -->
      <div style="border-top:1px dashed rgba(167,243,208,0.25); padding-top:8px; margin-top:8px;">
        <h5 style="margin:0 0 6px 0; color:#a7f3d0; opacity:0.9;">Gastos Tarjeta Fijos (se cargan al √∫ltimo d√≠a de cada mes)</h5>
        <div style="display:grid; grid-template-columns: 2fr 1fr auto; gap:8px; margin-bottom:6px;">
          <input type="text" id="in-tar-con" placeholder="Concepto fijo tarjeta" style="border-color:rgba(167,243,208,0.2); background:rgba(15,23,42,0.6);">
          <input type="number" id="in-tar-mon" placeholder="‚Ç¨/mes" style="border-color:rgba(167,243,208,0.2); background:rgba(15,23,42,0.6);">
          <button onclick="crearFijoTarjeta()" style="background:#0b3b2e; color:#a7f3d0; border:1px solid rgba(167,243,208,0.3); border-radius:6px; cursor:pointer; font-weight:bold; height:30px;">Programar</button>
        </div>
        <div class="meses-selector" id="meses-tar" style="margin-bottom:6px;"></div>
        <div id="lista-tarjeta-fijos" style="display:flex; flex-direction:column; gap:4px;"></div>
      </div>
    </div>

    <!-- AHORRO -->
    <div style="background: rgba(254, 243, 199, 0.05); padding: 10px; border-radius: 10px; border: 1px solid rgba(254, 243, 199, 0.15); margin-top: 18px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h4 style="color:#fef3c7; margin:0; font-size:0.72rem; text-transform:uppercase; letter-spacing:0.5px; opacity:0.85;">üè¶ Planificaci√≥n de Ahorro</h4>
        <span id="total-ahorro" style="color:#fef3c7; font-weight:bold; font-family:'JetBrains Mono', monospace; font-size:1rem;">0 ‚Ç¨</span>
      </div>
      <div style="display:grid; grid-template-columns: 1.2fr 2fr 1fr auto; gap:6px; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid rgba(254,243,199,0.1);">
        <input type="date" id="ahorro-fec" style="border-color:rgba(254,243,199,0.1); background:rgba(15,23,42,0.6); color:white; padding:6px; border-radius:4px; font-size:0.75rem;">
        <input type="text" id="ahorro-con" placeholder="Ahorro puntual..." style="border-color:rgba(254,243,199,0.1); background:rgba(15,23,42,0.6); color:white; padding:6px; border-radius:4px; font-size:0.75rem;">
        <input type="number" id="ahorro-mon" placeholder="‚Ç¨" style="border-color:rgba(254,243,199,0.1); background:rgba(15,23,42,0.6); color:white; padding:6px; border-radius:4px; font-size:0.75rem;">
        <button onclick="a√±adirAhorro()" style="background:#78350f; color:#fef3c7; border:1px solid rgba(254,243,199,0.2); border-radius:4px; cursor:pointer; padding:0 10px; font-weight:bold; font-size:0.7rem; height:28px;">+ Puntual</button>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:grid; grid-template-columns: 2fr 1fr 0.8fr auto; gap:6px;">
          <input type="text" id="in-aho-con" placeholder="Ahorro fijo (Ej: Fondo)" style="border-color:rgba(254,243,199,0.1); background:rgba(15,23,42,0.6); color:white; padding:6px; border-radius:4px; font-size:0.75rem;">
          <input type="number" id="in-aho-mon" placeholder="‚Ç¨/mes" style="border-color:rgba(254,243,199,0.1); background:rgba(15,23,42,0.6); color:white; padding:6px; border-radius:4px; font-size:0.75rem;">
          <input type="number" id="in-aho-dia" placeholder="D√≠a" value="7" style="border-color:rgba(254,243,199,0.1); background:rgba(15,23,42,0.6); color:white; padding:6px; border-radius:4px; font-size:0.75rem;">
          <button onclick="crearFijo('ahorro')" style="background:#fef3c7; color:#78350f; border:none; border-radius:4px; cursor:pointer; padding:0 10px; font-weight:bold; font-size:0.7rem; height:28px;">Programar</button>
        </div>
        <div id="meses-aho" class="meses-grid" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:4px;"></div>
      </div>
      <div style="margin-top:10px; border-top:1px solid rgba(254,243,199,0.1); padding-top:8px;">
        <span style="color:#fef3c7; font-size:0.62rem; text-transform:uppercase; opacity:0.65;">üìã Ahorros Programados:</span>
        <div id="lista-ahorros-fijos" style="margin-top:6px; display:flex; flex-direction:column; gap:4px;"></div>
      </div>
    </div>

    <!-- FIJOS: INGRESOS / GASTOS GENERALES -->
    <div class="fijos-container" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:10px; width:100%; margin: 12px 0 16px;">
      <div class="bloque-fijos" style="border-top: 4px solid var(--success); background: rgba(15, 23, 42, 0.4);">
        <h3 style="color:var(--success); font-size:0.78rem; margin:0 0 6px 0;">üí∞ Ingresos Fijos</h3>
        <div id="form-ingreso">
          <input type="text" id="in-ing-con" placeholder="Concepto" style="width:100%; margin-bottom:4px;">
          <div style="display:flex; gap:6px; margin-bottom:4px;">
            <input type="number" id="in-ing-mon" placeholder="‚Ç¨" style="flex:1;">
            <input type="number" id="in-ing-dia" placeholder="D√≠a" style="flex:1;">
            <label style="display:flex; align-items:center; gap:6px; font-size:0.75rem; color:#a7f3d0;">
              <input type="checkbox" id="in-ing-fin"> Fin de mes
            </label>
          </div>
          <div class="meses-selector" id="meses-ing" style="margin-bottom:6px;"></div>
          <button class="btn-add-mini" onclick="crearFijo('ingreso')" style="width:100%;">A√±adir Recurrente</button>
          <div class="ipc-row">
            <label for="in-ing-ipc">Crecimiento anual (%):</label>
            <input type="number" id="in-ing-ipc" value="1" step="0.1">
            <button class="btn-ipc-mini" onclick="recalcularTodo('ingreso')" style="background:var(--success); color:white;">APLICAR IPC</button>
          </div>
        </div>
        <div id="lista-ingresos" style="margin-top:8px;"></div>
      </div>

      <div class="bloque-fijos" style="border-top: 4px solid var(--danger); background: rgba(15, 23, 42, 0.4);">
        <h3 style="color:var(--danger); font-size:0.78rem; margin:0 0 6px 0;">üí∏ Gastos Fijos</h3>
        <div id="form-gasto">
          <input type="text" id="in-gas-con" placeholder="Concepto" style="width:100%; margin-bottom:4px;">
          <div style="display:flex; gap:6px; margin-bottom:4px;">
            <input type="number" id="in-gas-mon" placeholder="‚Ç¨" style="flex:1;">
            <input type="number" id="in-gas-dia" placeholder="D√≠a" style="flex:1;">
            <label style="display:flex; align-items:center; gap:6px; font-size:0.75rem; color:#a7f3d0;">
              <input type="checkbox" id="in-gas-fin"> Fin de mes
            </label>
          </div>
          <div class="meses-selector" id="meses-gas" style="margin-bottom:6px;"></div>
          <button class="btn-add-mini" onclick="crearFijo('gasto')" style="width:100%; background:var(--danger); color:white;">A√±adir Recurrente</button>
          <div class="ipc-row">
            <label for="in-gas-ipc">Incremento anual (%):</label>
            <input type="number" id="in-gas-ipc" value="2" step="0.1">
            <button class="btn-ipc-mini" onclick="recalcularTodo('gasto')" style="background:var(--danger); color:white;">APLICAR IPC</button>
          </div>
        </div>
        <div id="lista-gastos" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- Copias/backup -->
    <div style="margin-top: 10px; padding: 10px; border-top: 1px dashed #334155; text-align: center; width: 100%;">
      <p style="font-size: 0.68rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Gesti√≥n de Datos y Copias de Seguridad</p>
      <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
        <button id="btn-export" onclick="exportarDatos()" style="background: rgba(56, 189, 248, 0.1); color: #38bdf8; border: 1px solid #38bdf8; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.78rem; font-weight: bold;">üì• GUARDAR COPIA (JSON)</button>
        <button onclick="document.getElementById('input-import').click()" style="background: transparent; color: #94a3b8; border: 1px solid #334155; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.78rem;">üì§ CARGAR COPIA</button>
      </div>
      <div id="status-carga" style="font-size: 0.65rem; color: #fb923c; margin-top: 6px; font-weight: bold; height: 14px;"></div>
      <input type="file" id="input-import" style="display:none" accept=".json" onchange="importarDatos(event)">
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const STORAGE_DATA  = 'cuentas_vFinal_data';
    const STORAGE_FIJOS = 'cuentas_vFinal_fijos';
    const STORAGE_UI    = 'ui_compacto';
    const MESES_NOM     = ['E','F','M','A','M','J','J','A','S','O','N','D'];
    const ANIO_LIMITE_MAX = 2035;

    let baseDatos    = JSON.parse(localStorage.getItem(STORAGE_DATA))  || {};
    let maestroFijos = JSON.parse(localStorage.getItem(STORAGE_FIJOS)) || { ingreso: [], gasto: [] };
    let hayCambiosSinGuardar = false;

    const DEFAULT_IPC = { ingreso: 1, gasto: 2 };

    // ========= ESCAPAR (anti‚ÄëXSS b√°sico) =========
    function esc(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // ========= COMPACTO TOGGLE =========
    function toggleCompacto() {
      const root = document.getElementById('root');
      root.classList.toggle('compacto');
      localStorage.setItem(STORAGE_UI, root.classList.contains('compacto') ? '1' : '0');
    }
    (function loadCompactPref(){
      const pref = localStorage.getItem(STORAGE_UI);
      const root = document.getElementById('root');
      if (pref === '0') root.classList.remove('compacto'); // por defecto viene compacto
    })();

    // ========= SAVE =========
    function save() {
      try {
        localStorage.setItem(STORAGE_DATA,  JSON.stringify(baseDatos));
        localStorage.setItem(STORAGE_FIJOS, JSON.stringify(maestroFijos));
        hayCambiosSinGuardar = true;
        const cuerpo = document.getElementById('cuerpo'); if (cuerpo) cuerpo.innerHTML = '';
        render();
        if (typeof gestionarAvisoCambios === "function") gestionarAvisoCambios();
      } catch (e) { console.error("Error al guardar:", e); }
    }
    function gestionarAvisoCambios() {
      const btn = document.getElementById('btn-export');
      const status = document.getElementById('status-carga');
      if (!btn || !status) return;
      if (hayCambiosSinGuardar) {
        btn.style.backgroundColor = "#f87171"; btn.style.color = "white";
        btn.innerText = "‚ö†Ô∏è GUARDAR COPIA (JSON)"; status.innerText = "Cambios pendientes de exportar al archivo.";
      } else {
        btn.style.backgroundColor = "transparent"; btn.style.color = "var(--text-dim)";
        btn.innerText = "üì• GUARDAR COPIA (JSON)"; status.innerText = "Datos sincronizados.";
      }
    }

    // ========= UI INIT =========
    function initMesesSelectors() {
      ['ing', 'gas', 'aho', 'tar'].forEach(tipo => {
        const cont = document.getElementById(`meses-${tipo}`);
        if (!cont) return;
        cont.innerHTML = '';
        MESES_NOM.forEach((m, i) => {
          const btn = document.createElement('button');
          btn.className = 'mes-btn active';
          btn.innerText = m;
          btn.onclick = () => btn.classList.toggle('active');
          btn.dataset.mes = i;
          cont.appendChild(btn);
        });
      });
    }

    // Selector de a√±o
    const selAnio = document.getElementById('select-anio');
    if (selAnio) {
      selAnio.innerHTML = '';
      for (let i = 2026; i <= ANIO_LIMITE_MAX; i++) {
        const opt = document.createElement('option'); opt.value = i; opt.textContent = i; selAnio.appendChild(opt);
      }
      const y = new Date().getFullYear();
      selAnio.value = (y >= 2026 && y <= ANIO_LIMITE_MAX) ? y : 2026;
    }

    // ========= C√ÅLCULOS =========
    function format(n) { return new Intl.NumberFormat('de-DE').format(Math.round(n)) + ' ‚Ç¨'; }

    function calcularSaldoInicial(anioLimite) {
      let saldo = 0;
      Object.keys(baseDatos).forEach(f => {
        const a = parseInt(f.split('-')[0], 10);
        if (a < anioLimite) baseDatos[f].forEach(mov => { saldo += (mov.tipo === 'ingreso' ? mov.monto : -mov.monto); });
      });
      return saldo;
    }

    function getIPCForYear(fijo, tipo, anio) {
      if (!fijo.ipcOverrides) fijo.ipcOverrides = {};
      if (Object.prototype.hasOwnProperty.call(fijo.ipcOverrides, anio)) {
        const v = parseFloat(fijo.ipcOverrides[anio]); return isNaN(v) ? 0 : v;
      }
      if (typeof fijo.ipc === 'number') return fijo.ipc;
      return DEFAULT_IPC[tipo] ?? 0;
    }

    function calcularMontoParaAnio(fijo, tipo, anioObjetivo) {
      const anioBase = fijo.anioInicio ?? anioObjetivo;
      let importe = fijo.monto;
      for (let a = anioBase + 1; a <= anioObjetivo; a++) {
        const tasa = getIPCForYear(fijo, tipo, a);
        importe = Math.round(importe * (1 + (tasa / 100)));
      }
      return importe;
    }

    // ========= RENDER =========
    function render() {
      const anioVista = parseInt(selAnio.value, 10);
      const cuerpo = document.getElementById('cuerpo'); if (!cuerpo) return; cuerpo.innerHTML = '';
      let saldoGlobal = calcularSaldoInicial(anioVista);
      let hoy = new Date(); hoy.setHours(0,0,0,0);
      let pNeg = null, mNeg = { monto: 0, fecha: null };
      let f = new Date(anioVista, 0, 1);

      while (f.getFullYear() === anioVista) {
        const iso = `${f.getFullYear()}-${String(f.getMonth()+1).padStart(2,'0')}-${String(f.getDate()).padStart(2,'0')}`;
        const esUlt = (new Date(anioVista, f.getMonth() + 1, 0).getDate() === f.getDate());
        const movs = baseDatos[iso] || [];

        movs.forEach(mov => { saldoGlobal += (mov.tipo === 'ingreso' ? mov.monto : -mov.monto); });

        let hCon = '', hCif = '';
        movs.forEach((m, i) => {
          const color = m.tipo === 'ingreso' ? 'var(--success)' : 'var(--warning)';
          const signo = m.tipo === 'ingreso' ? '+' : '-';
          const esFijo = ((m.origen ?? 'manual') === 'fijo');
          const botones = esFijo
            ? `<span>
                 <button title="Editar esta ocurrencia (fijo)" style="background:#1f2937; color:#a7f3d0; border:1px solid #334155; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.68rem;" onclick="editarMovimientoFijo('${iso}', ${i})">‚úèÔ∏è</button>
                 <button title="Borrar solo esta ocurrencia (fijo)" style="background:transparent; color:var(--danger); border:none; cursor:pointer; font-size:0.9rem;" onclick="borrarMovimientoFijo('${iso}', ${i})">‚úï</button>
               </span>`
            : `<span>
                 <button title="Editar" style="background:#1f2937; color:#a7f3d0; border:1px solid #334155; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.68rem;" onclick="editarMovimiento('${iso}', ${i})">‚úèÔ∏è</button>
                 <button title="Borrar" style="background:transparent; color:var(--danger); border:none; cursor:pointer; font-size:0.9rem;" onclick="borrarMovimiento('${iso}', ${i})">‚úï</button>
               </span>`;
          hCon += `<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                     <span>${esc(m.concepto ?? '')} ${esFijo && m.excepcion ? '<em style="color:#93c5fd; font-size:0.7rem;">(excepci√≥n)</em>' : ''}</span>${botones}
                   </div>`;
          hCif += `<div class="moneda-font" style="color:${color}; text-align:right;">${signo}${format(m.monto)}</div>`;
        });

        if (movs.length === 0) { hCon = '---'; hCif = '---'; }

        // Mostrar fila si hay movimientos, o si es 1 de enero, o √∫ltimo d√≠a del mes
        if (movs.length > 0 || (f.getDate() === 1 && f.getMonth() === 0) || esUlt) {
          cuerpo.innerHTML += `<tr class="${esUlt?'fila-hito':''}">
            <td style="color:var(--text-dim)">${f.getDate()} ${f.toLocaleDateString('es-ES',{month:'short'})}</td>
            <td>${hCon}</td>
            <td class="moneda-font">${hCif}</td>
            <td class="moneda-font" style="color:${saldoGlobal>=0?'var(--success)':'var(--danger)'}">${format(saldoGlobal)}</td>
          </tr>`;
        }

        if (f >= hoy && saldoGlobal < 0) {
          if (!pNeg) pNeg = { fecha: new Date(f), monto: saldoGlobal };
          if (saldoGlobal < mNeg.monto) mNeg = { monto: saldoGlobal, fecha: new Date(f) };
        }
        f.setDate(f.getDate() + 1);
      }
      actualizarAlertas(saldoGlobal, pNeg, mNeg);
      actualizarListaFijos();
      actualizarHucha();
    }

    function actualizarAlertas(sFinal, pN, mN) {
      const recupera = pN && sFinal >= 0;
      const panel = document.getElementById('panel-alertas'); if (!panel) return;
      panel.innerHTML = `
        <div class="alerta-card" style="border-top: 4px solid var(--neon-lime)">
          <h4 style="color: var(--neon-lime)">‚ö†Ô∏è Monitor de Riesgos (${selAnio.value})</h4>
          <div class="monitor-negativo">
            <div class="punto-info"><label>Primer Negativo</label><span>${pN ? pN.fecha.toLocaleDateString('es-ES',{day:'numeric',month:'short'}) : 'Ninguno'}</span><div style="font-size:0.75rem; color:var(--danger); font-weight:bold; margin-top:2px">${pN ? format(pN.monto) : ''}</div></div>
            <div class="punto-info"><label>Punto m√°s bajo</label><span style="color:var(--danger)">${mN.fecha ? format(mN.monto) : '---'}</span><div style="font-size:0.75rem; color:var(--text-dim); margin-top:2px">${mN.fecha ? mN.fecha.toLocaleDateString('es-ES',{day:'numeric',month:'short'}) : ''}</div></div>
            <div class="punto-info"><label>Recuperaci√≥n</label><span>${recupera ? 'S√ç ‚úÖ' : (pN ? 'NO ‚ùå' : '---')}</span><div style="font-size:0.6rem; color:var(--text-dim); margin-top:2px">A 31 de DIC</div></div>
          </div>
        </div>
        <div class="alerta-card" style="border-top: 4px solid var(--neon-lime); text-align:center">
          <h4 style="color: var(--neon-lime)">üí∞ Saldo al 31 de Diciembre</h4>
          <div class="moneda-font" style="font-size:1.3rem; color:${sFinal >= 0 ? 'var(--neon-lime)' : 'var(--danger)'}">${format(sFinal)}</div>
        </div>`;
    }

    // ========= ENTRADA MANUAL =========
    function agregarManual() {
      const f = document.getElementById('input-fecha').value,
            c = document.getElementById('input-concepto').value,
            m = document.getElementById('input-monto').value,
            t = document.getElementById('input-tipo').value;
      if (!f || !c || !m) return alert("Faltan datos");
      if (!baseDatos[f]) baseDatos[f] = [];
      baseDatos[f].push({ concepto: c, monto: parseInt(m,10), tipo: t, origen: 'manual' });
      document.getElementById('input-concepto').value = '';
      document.getElementById('input-monto').value = '';
      save();
      document.getElementById('input-concepto').focus();
    }

    function a√±adirGastoTarjeta() {
      const concepto = document.getElementById('tarjeta-con').value;
      const monto = document.getElementById('tarjeta-mon').value;
      if (!concepto || !monto) return alert("Indica el concepto e importe");
      const anioActual = parseInt(selAnio.value,10);
      const mesActual = new Date().getMonth();
      const ultimoDia = new Date(anioActual, mesActual + 1, 0).getDate();
      const fechaISO = `${anioActual}-${String(mesActual + 1).padStart(2, '0')}-${String(ultimoDia).padStart(2, '0')}`;
      if (!baseDatos[fechaISO]) baseDatos[fechaISO] = [];
      baseDatos[fechaISO].push({ concepto: `[TARJETA] ${concepto}`, monto: parseInt(monto,10), tipo: 'gasto', origen: 'manual' });
      document.getElementById('tarjeta-con').value = '';
      document.getElementById('tarjeta-mon').value = '';
      save();
      document.getElementById('tarjeta-con').focus();
    }

    // ========= FIJOS =========
    function uniqId() { return (Date.now().toString(36) + Math.random().toString(36).slice(2,8)); }

    // Vigencia: parsear meses del √∫ltimo a√±o (input humano -> [0..11] o null)
    function parseMesesUltimoAnio(input) {
      if (!input) return null;
      const txt = String(input).trim();
      if (!txt) return null;
      if (/^\d+\s*-\s*\d+$/.test(txt)) {
        const [a,b] = txt.split('-').map(x => parseInt(x.trim(),10));
        const ini = Math.max(1, Math.min(a,b));
        const fin = Math.min(12, Math.max(a,b));
        return Array.from({length: (fin-ini+1)}, (_,i) => (ini+i)-1);
      }
      const arr = txt.split(',').map(x => parseInt(x.trim(),10))
        .filter(n => !isNaN(n) && n>=1 && n<=12)
        .map(n => n-1);
      return arr.length ? Array.from(new Set(arr)).sort((x,y)=>x-y) : null;
    }

    function crearFijo(tipo) {
      const t = tipo === 'ahorro' ? 'aho' : (tipo === 'ingreso' ? 'ing' : 'gas');
      const con = document.getElementById(`in-${t}-con`).value;
      const mon = parseInt(document.getElementById(`in-${t}-mon`).value,10);
      const finDeMesCheck = document.getElementById(`in-${t}-fin`);
      const finDeMes = !!(finDeMesCheck && finDeMesCheck.checked);
      const diaInput = document.getElementById(`in-${t}-dia`);
      const dia = finDeMes ? 28 : parseInt(diaInput?.value ?? 1,10);
      const ipcInput = document.getElementById(`in-${t}-ipc`);
      const defaultIpc = (tipo === 'ingreso') ? 1 : 2;
      const ipc = (ipcInput && ipcInput.value !== "") ? parseFloat(ipcInput.value) : defaultIpc;
      const meses = Array.from(document.querySelectorAll(`#meses-${t} .mes-btn.active`)).map(b => parseInt(b.dataset.mes,10));

      if (!con || !mon || (!finDeMes && !dia) || meses.length === 0) {
        return alert("Faltan datos");
      }
      const anioSel = parseInt(selAnio.value,10);
      let finRaw = prompt(`¬øHasta qu√© a√±o lo quieres? (YYYY, inclusive)\nDeja vac√≠o = solo ${anioSel}`, anioSel);
      let anioFin = parseInt((finRaw || anioSel), 10);
      if (isNaN(anioFin) || anioFin < anioSel) anioFin = anioSel;

      let mesesUltRaw = prompt(
        `Meses del √∫ltimo a√±o (${anioFin}).\nEjemplos: "1-12" (todos) o "1,2,3,4,5,6".\nDeja vac√≠o = los mismos de todos los a√±os.`,
        ""
      );
      const mesesUltimo = parseMesesUltimoAnio(mesesUltRaw);

      const conceptoFinal = tipo === 'ahorro' ? `[AHORRO] ${con}` : con;
      const tipoMovimiento = tipo === 'ahorro' ? 'gasto' : tipo;

      const nuevo = {
        id: uniqId(),
        concepto: conceptoFinal,
        monto: mon,
        dia: dia,             // si finDeMes=true, no se usa
        meses: meses,
        finDeMes: finDeMes,   // activa √∫ltimo d√≠a de cada mes
        ipc: isNaN(ipc) ? defaultIpc : ipc,
        ipcOverrides: {},
        excepciones: {},
        anioInicio: anioSel,
        vigencia: { anioFin, mesesUltimoAnio: mesesUltimo || null }
      };
      maestroFijos[tipoMovimiento].push(nuevo);
      aplicarDesde(tipoMovimiento, nuevo, anioSel, 0);
      save();
    }

    // Fijos de tarjeta (fin de mes)
    function crearFijoTarjeta() {
      const con = document.getElementById('in-tar-con').value;
      const mon = parseInt(document.getElementById('in-tar-mon').value,10);
      const meses = Array.from(document.querySelectorAll(`#meses-tar .mes-btn.active`)).map(b => parseInt(b.dataset.mes,10));
      if (!con || !mon || meses.length === 0) return alert("Faltan datos en fijo Tarjeta");

      const anioSel = parseInt(selAnio.value,10);
      let finRaw = prompt(`¬øHasta qu√© a√±o lo quieres? (YYYY, inclusive)\nDeja vac√≠o = solo ${anioSel}`, anioSel);
      let anioFin = parseInt((finRaw || anioSel), 10);
      if (isNaN(anioFin) || anioFin < anioSel) anioFin = anioSel;

      let mesesUltRaw = prompt(
        `Meses del √∫ltimo a√±o (${anioFin}).\nEjemplos: "1-12" (todos) o "1,2,3,4,5,6".\nDeja vac√≠o = los mismos de todos los a√±os.`,
        ""
      );
      const mesesUltimo = parseMesesUltimoAnio(mesesUltRaw);

      const nuevo = {
        id: uniqId(),
        concepto: `[TARJETA] ${con}`,
        monto: mon,
        dia: 28, // placeholder; se ignora con finDeMes=true
        meses: meses,
        finDeMes: true,
        ipc: DEFAULT_IPC.gasto,
        ipcOverrides: {},
        excepciones: {},
        anioInicio: anioSel,
        vigencia: { anioFin, mesesUltimoAnio: mesesUltimo || null }
      };
      maestroFijos['gasto'].push(nuevo);
      aplicarDesde('gasto', nuevo, anioSel, 0);
      document.getElementById('in-tar-con').value = '';
      document.getElementById('in-tar-mon').value = '';
      save();
    }

    // Aplicaci√≥n iterativa (limpia por fijoId, soporta fin de mes y excepciones)
    function aplicarDesde(tipo, fijo, anioInicio, mesInicio) {
      const anioFin = Math.min(
        (fijo.vigencia && fijo.vigencia.anioFin) ? fijo.vigencia.anioFin : ANIO_LIMITE_MAX,
        ANIO_LIMITE_MAX
      );
      // 1) Limpieza: SOLO ocurrencias de ESTE fijo (por id)
      for (let a = anioInicio; a <= anioFin; a++) {
        for (let m = 0; m <= 11; m++) {
          const prefijoFecha = `${a}-${String(m + 1).padStart(2, '0')}`;
          Object.keys(baseDatos).forEach(fecha => {
            if (fecha.startsWith(prefijoFecha)) {
              baseDatos[fecha] = baseDatos[fecha].filter(x => !(x.origen === 'fijo' && x.fijoId === fijo.id));
              if (baseDatos[fecha].length === 0) delete baseDatos[fecha];
            }
          });
        }
      }
      // 2) Reaplicaci√≥n a√±o a a√±o
      for (let a = anioInicio; a <= anioFin; a++) {
        const montoAnual = calcularMontoParaAnio(fijo, tipo, a);
        const mesesDeEsteAnio = (a === anioFin && fijo.vigencia && Array.isArray(fijo.vigencia.mesesUltimoAnio) && fijo.vigencia.mesesUltimoAnio.length)
          ? fijo.vigencia.mesesUltimoAnio
          : fijo.meses;
        mesesDeEsteAnio.forEach(m => {
          if (a > anioInicio || m >= mesInicio) {
            const lastDay = new Date(a, m + 1, 0).getDate();
            const dia = fijo.finDeMes ? lastDay : fijo.dia;
            const iso = `${a}-${String(m + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            const exc = (fijo.excepciones && fijo.excepciones[iso]) ? fijo.excepciones[iso] : null;
            if (exc && (exc.cancelar || exc.borrado)) return;
            const conceptoUse = (exc && typeof exc.concepto === 'string') ? exc.concepto : fijo.concepto;
            const montoUse = (exc && typeof exc.monto === 'number') ? exc.monto : montoAnual;
            if (!baseDatos[iso]) baseDatos[iso] = [];
            baseDatos[iso].push({
              concepto: conceptoUse,
              monto: Math.round(montoUse),
              tipo: tipo,
              origen: 'fijo',
              fijoId: fijo.id,
              excepcion: !!exc
            });
          }
        });
      }
    }

    
function editarFijo(tipo, index) {
  const fijo = maestroFijos[tipo][index];
  const anioSel = parseInt(selAnio.value, 10);

  // Modal base
  const modal = document.createElement('div');
  modal.id = 'modal-editar-fijo';
  modal.style = `
    position:fixed; inset:0; background:rgba(15,23,42,.85);
    display:flex; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(4px);
  `;

  // UI de meses (se marca .active si estaba elegido)
  const mesesMarkup = MESES_NOM.map((m, i) => `
    <button type="button"
      class="mes-btn ${fijo.meses.includes(i) ? 'active' : ''}"
      data-mes="${i}"
      style="
        padding:6px 8px; border:1px solid #334155; border-radius:6px;
        background:${fijo.meses.includes(i) ? 'var(--accent)' : 'transparent'};
        color:${fijo.meses.includes(i) ? 'var(--bg-body)' : '#cbd5e1'};
        cursor:pointer; transition:all .12s ease;
      ">
      ${m}
    </button>
  `).join('');

  // Plantilla del modal
  modal.innerHTML = `
    <div style="background:#0b1220; border:1px solid #334155; width:95%; max-width:560px; padding:16px; border-radius:12px; color:#e5e7eb; position:relative;">
      <button onclick="document.getElementById('modal-editar-fijo').remove()"
        style="position:absolute; right:10px; top:10px; background:transparent; border:none; color:#94a3b8; font-size:20px; cursor:pointer;">‚úï</button>

      <h3 style="margin:0 0 10px 0;">Editar fijo</h3>
      <div style="font-size:.9rem; color:#94a3b8; margin-bottom:12px;">${fijo.concepto}</div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
        <div>
          <label style="font-size:.75rem; color:#94a3b8;">Importe (‚Ç¨)</label>
          <input id="ed-monto" type="number" value="${fijo.monto}"
            style="width:100%; padding:8px; border-radius:6px; background:#0f172a; border:1px solid #334155; color:white;">
        </div>
        <div>
          <label style="font-size:.75rem; color:#94a3b8;">Fin de mes</label>
          <select id="ed-finmes" style="width:100%; padding:8px; border-radius:6px; background:#0f172a; border:1px solid #334155; color:white;">
            <option value="si" ${fijo.finDeMes ? 'selected' : ''}>S√≠</option>
            <option value="no" ${!fijo.finDeMes ? 'selected' : ''}>No</option>
          </select>
        </div>
        <div>
          <label style="font-size:.75rem; color:#94a3b8;">D√≠a (1-31)</label>
          <input id="ed-dia" type="number" value="${fijo.finDeMes ? 28 : (fijo.dia ?? 1)}"
            style="width:100%; padding:8px; border-radius:6px; background:#0f172a; border:1px solid #334155; color:white;"
            ${fijo.finDeMes ? 'disabled' : ''}>
        </div>
      </div>

      <!-- Secci√≥n meses -->
      <div style="display:flex; align-items:center; justify-content:space-between; margin:10px 0 6px;">
        <div style="font-size:.75rem; color:#94a3b8;">Meses activos</div>
        <div id="ed-resumen" style="font-size:.75rem; color:#a7f3d0;"></div>
      </div>
      <div id="ed-meses" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:14px;">
        ${mesesMarkup}
      </div>

      <div style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:6px;">
          <button type="button" id="ed-sel-todos"  style="background:transparent; color:#94a3b8; border:1px solid #334155; padding:6px 10px; border-radius:8px; cursor:pointer;">Todos</button>
          <button type="button" id="ed-sel-ninguno"style="background:transparent; color:#94a3b8; border:1px solid #334155; padding:6px 10px; border-radius:8px; cursor:pointer;">Ninguno</button>
          <button type="button" id="ed-sel-trimestre"style="background:transparent; color:#94a3b8; border:1px solid #334155; padding:6px 10px; border-radius:8px; cursor:pointer;">Trim. actual</button>
        </div>
        <div style="display:flex; gap:8px;">
          <button type="button" id="ed-cancel" style="background:transparent; color:#94a3b8; border:1px solid #334155; padding:8px 12px; border-radius:8px; cursor:pointer;">Cancelar</button>
          <button type="button" id="ed-save" style="background:#22c55e; color:#0b1220; border:none; padding:8px 14px; border-radius:8px; font-weight:700; cursor:pointer;">Guardar</button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Helpers DOM
  const nodoMeses = modal.querySelector('#ed-meses');
  const resumen   = modal.querySelector('#ed-resumen');
  const selFinMes = modal.querySelector('#ed-finmes');
  const inputDia  = modal.querySelector('#ed-dia');
  const inputMon  = modal.querySelector('#ed-monto');

  // Actualiza texto "Meses seleccionados: ..."
  function actualizarResumen() {
    const activos = Array.from(nodoMeses.querySelectorAll('button[data-mes].active'))
      .map(b => parseInt(b.dataset.mes, 10))
      .sort((a,b)=>a-b);
    const etiqueta = activos.length
      ? activos.map(i => MESES_NOM[i]).join(' ')
      : '(ninguno)';
    resumen.textContent = `Seleccionados: ${etiqueta}`;
  }
  actualizarResumen();

  // Toggling visual con feedback
  nodoMeses.addEventListener('click', (e) => {
    const b = e.target.closest('button[data-mes]');
    if (!b) return;
    b.classList.toggle('active');
    if (b.classList.contains('active')) {
      b.style.background = 'var(--accent)'; b.style.color = 'var(--bg-body)';
    } else {
      b.style.background = 'transparent';   b.style.color = '#cbd5e1';
    }
    actualizarResumen();
  });

  // Acciones r√°pidas
  modal.querySelector('#ed-sel-todos').onclick = () => {
    nodoMeses.querySelectorAll('button[data-mes]').forEach(b => {
      b.classList.add('active'); b.style.background = 'var(--accent)'; b.style.color = 'var(--bg-body)';
    });
    actualizarResumen();
  };
  modal.querySelector('#ed-sel-ninguno').onclick = () => {
    nodoMeses.querySelectorAll('button[data-mes]').forEach(b => {
      b.classList.remove('active'); b.style.background = 'transparent'; b.style.color = '#cbd5e1';
    });
    actualizarResumen();
  };
  modal.querySelector('#ed-sel-trimestre').onclick = () => {
    const now = new Date(); const q = Math.floor(now.getMonth() / 3); // 0..3
    const setQ = new Set([q*3, q*3+1, q*3+2]);
    nodoMeses.querySelectorAll('button[data-mes]').forEach(b => {
      const idx = parseInt(b.dataset.mes, 10);
      if (setQ.has(idx)) { b.classList.add('active'); b.style.background = 'var(--accent)'; b.style.color = 'var(--bg-body)'; }
      else { b.classList.remove('active'); b.style.background = 'transparent'; b.style.color = '#cbd5e1'; }
    });
    actualizarResumen();
  };

  // Fin de mes habilita/deshabilita el d√≠a
  selFinMes.addEventListener('change', () => {
    const fm = selFinMes.value === 'si';
    inputDia.disabled = fm;
  });

  // Botones guardar/cancelar
  modal.querySelector('#ed-cancel').onclick = () => modal.remove();

  modal.querySelector('#ed-save').onclick = () => {
    const monto = parseInt(inputMon.value, 10);
    const fm    = (selFinMes.value === 'si');
    let  dia    = fm ? 28 : parseInt(inputDia.value, 10);

    if (isNaN(monto) || monto < 0) { alert('Importe no v√°lido'); return; }
    if (!fm && (isNaN(dia) || dia < 1 || dia > 31)) { alert('D√≠a no v√°lido'); return; }

    const meses = Array.from(nodoMeses.querySelectorAll('button[data-mes].active'))
      .map(b => parseInt(b.dataset.mes, 10))
      .filter(n => !isNaN(n))
      .sort((a,b)=>a-b);
    if (!meses.length) { alert('Selecciona al menos un mes'); return; }

    // Aplicar cambios al fijo
    fijo.monto    = monto;
    fijo.finDeMes = fm;
    fijo.dia      = fm ? 28 : dia;
    fijo.meses    = meses;

    // Reaplicar desde el a√±o visible y guardar
    aplicarDesde(tipo, fijo, anioSel, 0);
    save();

    modal.remove();
  };
}


    function actualizarListaFijos() {
      const contIng = document.getElementById('lista-ingresos');
      const contGas = document.getElementById('lista-gastos');
      const contAho = document.getElementById('lista-ahorros-fijos');
      const contTar = document.getElementById('lista-tarjeta-fijos');
      if (contIng) contIng.innerHTML = '';
      if (contGas) contGas.innerHTML = '';
      if (contAho) contAho.innerHTML = '';
      if (contTar) contTar.innerHTML = '';
      ['ingreso', 'gasto'].forEach(tipo => {
        maestroFijos[tipo].forEach((f, i) => {
          const esAhorro = f.concepto.includes('[AHORRO]');
          const esTarjeta = f.concepto.includes('[TARJETA]');
          let destino = (tipo === 'ingreso') ? contIng : (esAhorro ? contAho : (esTarjeta && contTar ? contTar : contGas));
          if (!destino) return;
          const anioVista = parseInt(selAnio.value,10);
          const montoVista = calcularMontoParaAnio(f, tipo, anioVista);
          const etiquetaDia = f.finDeMes ? 'Fin de mes' : `D√≠a ${f.dia}`;
          destino.innerHTML += `
            <div class="item-fijo" style="${esAhorro ? 'border:1px solid rgba(254,243,199,0.2); background:rgba(254,243,199,0.05); padding:6px; border-radius:6px; margin-bottom:4px;' : 'border-top: 1px solid var(--border); padding: 6px 0;'}">
              <div style="display:flex; justify-content:space-between">
                <b style="${esAhorro ? 'color:#fef3c7;' : ''}">${esc(f.concepto.replace('[AHORRO] ', '').replace('[TARJETA] ', ''))}</b>
                <b style="color:${tipo==='ingreso'?'var(--success)':'var(--warning)'}">${format(montoVista)}</b>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px">
                <span style="font-size:0.58rem; color:var(--accent)">${f.meses.map(m=>MESES_NOM[m]).join(' ')} - ${etiquetaDia}</span>
                <div>
                  <button onclick="editarFijo('${tipo}',${i})" class="btn-edit">‚úèÔ∏è</button>
                  <button onclick="borrarFijo('${tipo}',${i})" class="btn-del">‚úï</button>
                </div>
              </div>
            </div>`;
        });
      });
    }

    // ========= IPC OVERRIDE =========
    function recalcularTodo(tipo) {
      const t = (tipo === 'ingreso') ? 'ing' : 'gas';
      const input = document.getElementById(`in-${t}-ipc`);
      const raw = input ? String(input.value).trim() : "";
      const anioActual = parseInt(selAnio.value,10);
      if (maestroFijos[tipo].length === 0) { alert("No hay elementos para actualizar."); return; }

      const ids = new Set(maestroFijos[tipo].map(f => f.id));
      Object.keys(baseDatos).forEach(fecha => {
        if (parseInt(fecha.split('-')[0],10) >= anioActual) {
          baseDatos[fecha] = baseDatos[fecha].filter(mov => !(mov.origen === 'fijo' && mov.fijoId && ids.has(mov.fijoId)));
          if (baseDatos[fecha].length === 0) delete baseDatos[fecha];
        }
      });

      const nuevoIpc = raw === "" ? null : parseFloat(raw);
      maestroFijos[tipo].forEach(fijo => {
        if (!fijo.ipcOverrides) fijo.ipcOverrides = {};
        if (nuevoIpc === null || isNaN(nuevoIpc)) delete fijo.ipcOverrides[anioActual];
        else fijo.ipcOverrides[anioActual] = nuevoIpc;
        aplicarDesde(tipo, fijo, anioActual, 0);
      });
      save();
      alert("Cifras actualizadas. Si no ves el cambio, cambia de a√±o en el selector y vuelve.");
    }

    // ========= BACKUP =========
    function exportarDatos() {
      const dataStr = JSON.stringify({ data: baseDatos, fijos: maestroFijos }, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `finanzas_${new Date().toISOString().slice(0,10)}.json`; a.click();
      hayCambiosSinGuardar = false; gestionarAvisoCambios();
    }
    function importarDatos(e) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imp = JSON.parse(ev.target.result);
          baseDatos = imp.data || {}; maestroFijos = imp.fijos || { ingreso: [], gasto: [] };
          hayCambiosSinGuardar = false; save(); location.reload();
        } catch (err) { alert("Archivo inv√°lido"); }
      };
      reader.readAsText(e.target.files[0]);
    }

    // ===============================
    // HELPERS NUEVOS
    // ===============================
    // Quita tags como [AHORRO] o [TARJETA] al mostrar/agrupar
    function quitarTags(concepto) {
      return (concepto ?? '').replace(/\[(AHORRO|TARJETA)\]\s*/gi, '').trim();
    }
    // Normaliza: min√∫sculas y sin acentos, para comparar textos
    function normaliza(s) {
      return (s ?? '').toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
    }
    // Capitaliza la primera letra
    function cap(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    /** Clasifica gastos de TARJETA por categor√≠a (alias, prefijo antes del punto, o primera palabra) */
    function categoriaTarjeta(nombre) {
      const clean = quitarTags(nombre);
      const lower = normaliza(clean);
      const alias = {
        // Vacaciones / viajes
        'vacaciones': 'Vacaciones', 'viaje': 'Vacaciones', 'hotel': 'Vacaciones',
        // Comida / s√∫per / restaurantes
        'comida': 'Comida', 'mercadona': 'Comida', 'carrefour': 'Comida',
        'lidl': 'Comida', 'aldi': 'Comida', 'ahorramas': 'Comida',
        'restaurante': 'Comida', 'uber eats': 'Comida', 'ubereats': 'Comida',
        'just eat': 'Comida', 'justeat': 'Comida', 'glovo': 'Comida',
        // Transporte
        'gasolina': 'Gasolina - Transporte', 'repsol': 'Gasolina - Transporte', 'cepsa': 'Gasolina - Transporte', 'bp': 'Gasolina - Transporte',
        // Varios ejemplo
        'amazon': 'Amazon', 'ikea': 'Hogar'
      };
      for (const k in alias) { if (lower.includes(k)) return alias[k]; }
      const preDot = clean.split('.')[0].trim();
      if (preDot.length >= 2) return cap(preDot);
      const primera = clean.split(/\s+/)[0];
      return primera ? cap(primera) : 'Otros';
    }

    function abrirDesglose() {
      const anio = parseInt(selAnio.value, 10);
      const mapIng = new Map();
      const mapGas = new Map();
      let totalAhorro = 0;
      const mapTarjetaDet = new Map();
      let totalTarjeta = 0;

      Object.keys(baseDatos).forEach(fecha => {
        if (!fecha.startsWith(anio + "-")) return;
        baseDatos[fecha].forEach(m => {
          const conceptoOriginal = m.concepto ?? 'Sin concepto';
          const conceptoLimpio = quitarTags(conceptoOriginal);
          const esAhorro = conceptoOriginal.includes('[AHORRO]');
          const esTarjeta = conceptoOriginal.includes('[TARJETA]');

          if (esAhorro) {
            if (m.tipo !== 'ingreso') totalAhorro += m.monto;
            return;
          }
          if (m.tipo === 'ingreso') {
            mapIng.set(conceptoLimpio, (mapIng.get(conceptoLimpio) || 0) + m.monto);
          } else {
            if (esTarjeta) {
              mapGas.set('Tarjeta', (mapGas.get('Tarjeta') || 0) + m.monto);
              const cat = categoriaTarjeta(conceptoOriginal);
              mapTarjetaDet.set(cat, (mapTarjetaDet.get(cat) || 0) + m.monto);
              totalTarjeta += m.monto;
            } else {
              mapGas.set(conceptoLimpio, (mapGas.get(conceptoLimpio) || 0) + m.monto);
            }
          }
        });
      });

      const ingList = Array.from(mapIng.entries()).sort((a, b) => b[1] - a[1]);
      const gasList = Array.from(mapGas.entries()).sort((a, b) => b[1] - a[1]);
      const tarjetaList = Array.from(mapTarjetaDet.entries()).sort((a, b) => b[1] - a[1]);
      const totalIng = ingList.reduce((s, [,v]) => s + v, 0);
      const totalGas = gasList.reduce((s, [,v]) => s + v, 0);

      const modal = document.createElement('div');
      modal.id = "modal-desglose";
      modal.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.9); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(4px);";

      const renderRows = (list, tipo) => {
        if (!list || list.length === 0) {
          return `<tr><td colspan="2" style="color:var(--text-dim); text-align:center; padding:8px;">(Sin datos)</td></tr>`;
        }
        const color = (tipo === 'ingreso') ? 'var(--success)' : 'var(--warning)';
        const signo = (tipo === 'ingreso') ? '+' : '-';
        return list.map(([k, v]) =>
          `<tr>
            <td style="padding:6px 8px; text-align:left;">${esc(k)}</td>
            <td class="moneda-font" style="padding:6px 8px; color:${color}; text-align:right;">${signo}${format(v)}</td>
          </tr>`
        ).join('');
      };

      const bloque = (titulo, list, tipo, total, color, signo) => `
        <div style="flex:1; min-width:250px;">
          <h4 style="margin:0 0 8px 0; color:${color};">${titulo}</h4>
          <div style="border:1px solid var(--border); border-radius:8px; overflow:hidden; background:rgba(15,23,42,0.4);">
            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
              <thead>
                <tr style="background:rgba(15,23,42,0.5); color:var(--text-dim); text-transform:uppercase; font-size:0.7rem;">
                  <th style="text-align:left; padding:8px;">Concepto</th>
                  <th style="text-align:right; padding:8px;">Total a√±o</th>
                </tr>
              </thead>
              <tbody>${renderRows(list, tipo)}</tbody>
              <tfoot>
                <tr style="background:rgba(0,0,0,0.2);">
                  <td style="padding:8px; text-align:left; font-weight:bold;">TOTAL</td>
                  <td class="moneda-font" style="padding:8px; text-align:right; color:${color}; font-weight:bold;">${signo}${format(total)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>`;

      const bloqueIngresos   = bloque(`Ingresos (${anio})`, ingList, 'ingreso', totalIng, 'var(--success)', '+');
      const bloqueAhorro     = `
        <div style="flex:1; min-width:250px;">
          <h4 style="margin:0 0 8px 0; color:#fef3c7;">Ahorro (${anio})</h4>
          <div style="border:1px solid var(--border); border-radius:8px; overflow:hidden; background:rgba(15,23,42,0.4);">
            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
              <thead>
                <tr style="background:rgba(15,23,42,0.5); color:var(--text-dim); text-transform:uppercase; font-size:0.7rem;">
                  <th style="text-align:left; padding:8px;">Concepto</th>
                  <th style="text-align:right; padding:8px;">Total a√±o</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding:6px 8px; text-align:left;">Ahorro</td>
                  <td class="moneda-font" style="padding:6px 8px; color:#fef3c7; text-align:right;">+${format(totalAhorro)}</td>
                </tr>
              </tbody>
              <tfoot>
                <tr style="background:rgba(0,0,0,0.2);">
                  <td style="padding:8px; text-align:left; font-weight:bold;">TOTAL</td>
                  <td class="moneda-font" style="padding:8px; text-align:right; color:#fef3c7; font-weight:bold;">+${format(totalAhorro)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>`;
      const bloqueGastos     = bloque(`Gastos (${anio})`,   gasList, 'gasto',   totalGas, 'var(--warning)', '-');
      const bloqueTarjetaDet = bloque(`Tarjeta (desglose)`, tarjetaList, 'gasto', totalTarjeta, 'var(--warning)', '-');

      modal.innerHTML = `
        <div style="background:var(--bg-card); width:95%; max-width:1280px; padding:20px; border-radius:16px; border:1px solid var(--neon-purple); max-height:85vh; overflow-y:auto; position:relative; box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);">
          <button onclick="document.getElementById('modal-desglose').remove()" style="position:absolute; top:10px; right:10px; background:none; border:none; color:var(--text-dim); font-size:1.4rem; cursor:pointer;">‚úï</button>
          <h2 style="color:var(--neon-purple); margin:0 0 12px 0; text-align:center; letter-spacing:1px;">üßæ DESGLOSE DE GASTOS / INGRESOS</h2>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            ${bloqueIngresos}
            ${bloqueAhorro}
            ${bloqueGastos}
            ${bloqueTarjetaDet}
          </div>
          <div style="margin-top:12px; text-align:center; color:var(--text-dim); font-size:0.72rem;">
            * ‚ÄúTarjeta (desglose)‚Äù clasifica solo movimientos con <code>[TARJETA]</code> por categor√≠as (palabra inicial, prefijo antes del punto o alias).<br/>
            * ‚ÄúGastos‚Äù mantiene ‚ÄúTarjeta‚Äù como l√≠nea agregada dentro del total.
          </div>
        </div>`;
      document.body.appendChild(modal);
    }

    // ========= AHORRO =========
    function a√±adirAhorro() {
      let fechaISO = document.getElementById('ahorro-fec').value;
      const concepto = document.getElementById('ahorro-con').value;
      const monto = document.getElementById('ahorro-mon').value;
      if (!concepto || !monto) return alert("Indica concepto e importe del ahorro");
      if (!fechaISO) { const hoy = new Date(); fechaISO = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`; }
      if (!baseDatos[fechaISO]) baseDatos[fechaISO] = [];
      baseDatos[fechaISO].push({ concepto: `[AHORRO] ${concepto}`, monto: parseInt(monto,10), tipo: 'gasto', origen: 'manual' });
      document.getElementById('ahorro-con').value = ''; document.getElementById('ahorro-mon').value = '';
      save(); document.getElementById('ahorro-con').focus();
    }
    function actualizarHucha() {
      let totalHucha = 0;
      Object.keys(baseDatos).forEach(fecha => {
        baseDatos[fecha].forEach(mov => { if (mov.concepto && mov.concepto.includes('[AHORRO]')) totalHucha += mov.monto; });
      });
      const el = document.getElementById('total-ahorro'); if (el) el.innerText = format(totalHucha);
    }

    // ========= EDITAR/BORRAR: MANUAL =========
    function editarMovimiento(fechaISO, index) {
      const movs = baseDatos[fechaISO]; if (!movs || !movs[index]) return;
      const mov = movs[index];
      if (((mov.origen ?? 'manual') === 'fijo')) { alert("Este movimiento es un fijo. Usa ‚úèÔ∏è de fijo para editar solo esa fecha."); return; }
      const nuevoConcepto = prompt("Nuevo concepto:", mov.concepto ?? ""); if (nuevoConcepto === null) return;
      const nuevoMontoRaw = prompt("Nuevo importe (‚Ç¨):", mov.monto); if (nuevoMontoRaw === null) return;
      const nuevoMonto = parseInt(nuevoMontoRaw,10); if (isNaN(nuevoMonto) || nuevoMonto < 0) { alert("Importe no v√°lido."); return; }
      const nuevoTipo = prompt("Tipo (ingreso/gasto):", mov.tipo); if (nuevoTipo === null) return;
      mov.concepto = nuevoConcepto; mov.monto = nuevoMonto; mov.tipo = (String(nuevoTipo).toLowerCase() === 'ingreso') ? 'ingreso' : 'gasto'; mov.origen = mov.origen ?? 'manual';
      save();
    }
    function borrarMovimiento(fechaISO, index) {
      const movs = baseDatos[fechaISO]; if (!movs || !movs[index]) return;
      const mov = movs[index];
      if (((mov.origen ?? 'manual') === 'fijo')) { alert("Este movimiento es un fijo. Usa ‚úï de fijo para borrar solo esa fecha."); return; }
      if (!confirm(`¬øBorrar "${mov.concepto}" de ${fechaISO}?`)) return;
      movs.splice(index, 1); if (movs.length === 0) delete baseDatos[fechaISO]; save();
    }

    // ========= EDITAR/BORRAR: FIJO (OCURRENCIA) =========
    function localizarFijoPorMovimiento(mov) {
      for (let tipo in maestroFijos) {
        const lista = maestroFijos[tipo];
        // Primero por id
        if (mov.fijoId) {
          const byId = lista.find(f => f.id === mov.fijoId);
          if (byId) return { fijo: byId, tipo: tipo };
        }
        // Fallback por concepto original
        const encontrado = lista.find(f => f.concepto === (mov.conceptoOriginal ?? mov.concepto));
        if (encontrado) return { fijo: encontrado, tipo: tipo };
      }
      return null;
    }

    function editarMovimientoFijo(fechaISO, index) {
      const movs = baseDatos[fechaISO]; if (!movs || !movs[index]) return;
      const mov = movs[index]; if (((mov.origen ?? 'manual') !== 'fijo')) { alert("No es una ocurrencia de fijo."); return; }
      const ref = localizarFijoPorMovimiento(mov); if (!ref) { alert("No se pudo localizar el fijo original."); return; }
      const { fijo, tipo } = ref;
      const nuevoConcepto = prompt("Nuevo concepto para esta fecha:", mov.concepto ?? fijo.concepto); if (nuevoConcepto === null) return;
      const nuevoMontoRaw = prompt("Nuevo importe (‚Ç¨) SOLO para esta fecha:", mov.monto); if (nuevoMontoRaw === null) return;
      const nuevoMonto = parseInt(nuevoMontoRaw,10); if (isNaN(nuevoMonto) || nuevoMonto < 0) { alert("Importe no v√°lido."); return; }
      if (!fijo.excepciones) fijo.excepciones = {}; fijo.excepciones[fechaISO] = { concepto: nuevoConcepto, monto: nuevoMonto };
      const anio = parseInt(fechaISO.split('-')[0],10); aplicarDesde(tipo, fijo, anio, 0); save();
    }

    function borrarMovimientoFijo(fechaISO, index) {
  const movs = baseDatos[fechaISO];
  if (!movs || !movs[index]) return;

  const mov = movs[index];
  const ref = localizarFijoPorMovimiento(mov);

  if (!ref) {
    // Si no se localiza el fijo, permite borrar manualmente la l√≠nea del d√≠a
    if (confirm("No se encontr√≥ el origen fijo. ¬øBorrar esta l√≠nea de todos modos?")) {
      movs.splice(index, 1);
      if (movs.length === 0) delete baseDatos[fechaISO]; // limpia el d√≠a si queda vac√≠o
      save();
    }
    return;
  }

  const { fijo, tipo } = ref;

  const opcion = confirm(
    `¬øQu√© quieres hacer con "${mov.concepto}"?\n\n- ACEPTAR: Borrar SOLO esta fecha.\n- CANCELAR: Borrar esta y TODAS las futuras.`
  );

  const anioCorte = parseInt(fechaISO.split('-')[0], 10);
  const mesCorte  = new Date(fechaISO).getMonth();

  if (opcion) {
    // ACEPTAR ‚Üí borrar SOLO esta fecha: marcar excepci√≥n y re-aplicar
    if (!fijo.excepciones) fijo.excepciones = {};
    fijo.excepciones[fechaISO] = { borrado: true };
    aplicarDesde(tipo, fijo, anioCorte, 0); // reconstruye ocurrencias del a√±o
    save();
  } else {
    // CANCELAR ‚Üí borrar esta y TODAS las futuras: limitar vigencia y re-aplicar
    if (!fijo.vigencia) fijo.vigencia = { anioFin: anioCorte, mesesUltimoAnio: null };
    fijo.vigencia.anioFin = anioCorte;

    // En el √∫ltimo a√±o, conservar solo los meses anteriores al corte
    const mesesPrevios = (fijo.meses || []).filter(m => m < mesCorte);
    fijo.vigencia.mesesUltimoAnio = mesesPrevios.length ? mesesPrevios : [];

    aplicarDesde(tipo, fijo, fijo.anioInicio || anioCorte, 0); // limpia todo lo futuro
    save();
    alert("Se ha limitado el fijo hasta el mes anterior a " + fechaISO);
  }
}


    // ========= LANZAR =========
    initMesesSelectors();
    render();
  </script>
</body>
</html>